<!DOCTYPE html>
<html lang="ja-jp">
<head>
<meta charset="utf-8">
<meta name="generator" content="Hugo 0.54.0" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="/blog/css/normalize.css">
<link rel="stylesheet" href="/blog/css/skeleton.css">
<link rel="stylesheet" href="/blog/css/custom.css">
<link rel="stylesheet" href="/blog/css/icomoon.css">
<link rel="stylesheet" href="/blog/css/syntax.css">
<link rel="alternate" href="/index.xml" type="application/rss+xml" title="わいがかいた">
<title>facebookのためにsocial loginをごにょごにょした話 - わいがかいた</title>
</head>
<body>

<div class="container">

    <header role="banner">
        <div class="header-logo">
            <a href="/blog"><img src="#ZgotmplZ" width="60" height="60" alt="わいがかいた"></a>
        </div>
        
    </header>


    <main role="main">
        <article itemscope itemtype="http://schema.org/BlogPosting">
            <h1 class="entry-title" itemprop="headline">facebookのためにsocial loginをごにょごにょした話</h1>
            <span class="entry-meta"><time itemprop="datePublished" datetime="2017-12-20">December 20, 2017</time><dl class="entry-categories"><dt class="category"><a href="/blog/categories/%e3%83%90%e3%83%83%e3%82%af%e3%82%a8%e3%83%b3%e3%83%89">バックエンド</a></dt></dl></span>
            
            <dl class="entry-tags">
                
                <dt class="tag"><a href="/blog/tags/facebook">#facebook</a></dt>
                
                <dt class="tag"><a href="/blog/tags/django">#django</a></dt>
                
                <dt class="tag"><a href="/blog/tags/python">#python</a></dt>
                
            </dl>
            
            <section itemprop="entry-text">
                

<p>facebookに見慣れぬアラートが。

<figure style="text-align: center">
    
        <img src="/blog/images/social-login-update-for-facebook/alert.png"   width="550"/>
    
    
    <figcaption>
        <span>突然のアラート</span>
        
    </figcaption>
    
</figure>

</p>


<figure style="text-align: center">
    
        <img src="/blog/images/social-login-update-for-facebook/message.png"   width="550"/>
    
    
    <figcaption>
        <span>難しい英文</span>
        
    </figcaption>
    
</figure>



<blockquote>
<p>In 90 days, we&rsquo;re making a security update to Facebook Login that will invalidate calls from URIs not listed in the Valid OAuth redirect URIs field of your Facebook Login settings.<br />
This update comes in response to malicious activity we saw on our platform, and we want to protect your app or website by requiring a new strict mode for redirect URIs. Take action now to ensure your redirect traffic continues to work. Learn More</p>
</blockquote>

<p>モニョモニョ言ってた。
要するに90日以内にstrict modeにしないとだめだよってことかな</p>

<p>いい機会なので見直すことにした。</p>

<h2 id="python-social-authに乗り換えた">python-social-authに乗り換えた</h2>

<ul>
<li>まず、メンテされていなかった<a href="https://github.com/omab/django-social-auth">omab/django-social-auth: Django social authentication made simple</a>から<a href="https://github.com/python-social-auth/social-app-django">python-social-auth/social-app-django: Python Social Auth - Application - Django</a>
に乗り換えた。

<ul>
<li><a href="http://python-social-auth.readthedocs.io/en/latest/index.html">ドキュメント</a>よんで、もろもろの<code>settings.py</code>の設定変更</li>
</ul></li>
</ul>

<h2 id="実装方法を決めた">実装方法を決めた</h2>

<ul>
<li>ソースを読んでみたけど、facebookに対して何か特別なoptionがあるわけではなく、現状対応できてないっぽい。

<ul>
<li>issueにあがってた

<ul>
<li><a href="https://github.com/python-social-auth/social-core/issues/141">social_core.backends.facebook.FacebookOAuth2 should have REDIRECT_STATE set to False · Issue #141 · python-social-auth/social-core</a></li>
</ul></li>
<li><code>redirect_state</code>を固定にするか、なくすかのどちらかなのだけど、<code>redirect_state</code>を固定にする方向で実装していくことにした</li>
</ul></li>
</ul>

<h2 id="backendを自作した">backendを自作した</h2>

<p>といってもまったく難しいことはしてなくて、クラスを継承して、対象メソッドを上書きしただけ。</p>

<pre><code class="language-python">from social_core.backends.facebook import FacebookOAuth2

class FacebookOAuth2Override(FacebookOAuth2):
    # 現在はデフォルトでTrueなので、これはなくても良い
    REDIRECT_STATE = True

    # get_or_create_stateを上書く
    def get_or_create_state(self):
        if self.STATE_PARAMETER or self.REDIRECT_STATE:
            # Store state in session for further request validation. The state
            # value is passed as state parameter (as specified in OAuth2 spec),
            # but also added to redirect, that way we can still verify the
            # request if the provider doesn't implement the state parameter.
            # Reuse token if any.
            name = self.name + '_state'
            state = self.strategy.session_get(name)
            try:
                # settings.pyのSOCIAL_AUTH_FACEBOOK_REDIRECT_STATEを見に行く
                static_state = self.strategy.get_setting('SOCIAL_AUTH_FACEBOOK_REDIRECT_STATE')
                # sessionに保存する必要があるかどうか
                if state != static_state:
                    self.strategy.session_set(name, static_state)
                state = static_state
            except:
                # SOCIAL_AUTH_FACEBOOK_REDIRECT_STATEがない場合
                # sessionにも何も保管されていなかったら新たに取得する
                if state is None:
                    state = self.state_token()
                    self.strategy.session_set(name, state)
        else:
            state = None
        return state
</code></pre>

<p>上記を適当なところにおいて(たとえば<code>myapp/custom_backends.py</code>としたら)</p>

<pre><code class="language-python">AUTHENTICATION_BACKENDS = (
    'social_core.backends.twitter.TwitterOAuth',
    # 'social_core.backends.facebook.FacebookOAuth2',
    'myapp.custom_backends.FacebookOAuth2Override',
    'django.contrib.auth.backends.ModelBackend',
)
SOCIAL_AUTH_FACEBOOK_REDIRECT_STATE = '{{static_state}}'
</code></pre>

<p>今の所こんな感じで問題なさそう。</p>

<p>facebook側の設定も忘れずに:(</p>

            </section>
        </article>
    </main>


    <footer role="contentinfo">
        <div class="hr"></div>
        <div class="footer-link">
            
            
            
            
        </div>
        <div class="copyright">Copyright &copy; </div>
    </footer>

</div>





</body>
</html>

