<!doctype html><html lang=ja><head><title>facebookのためにsocial loginをごにょごにょした話 ::
わいがかいた</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="facebookに見慣れぬアラートが。  突然のアラート    難しい英文    In 90 days, we&amp;rsquo;re making a security update to Facebook Login that will invalidate calls from URIs not listed in the Valid OAuth redirect URIs field of your Facebook Login settings.
This update comes in response to malicious activity we saw on our platform, and we want to protect your app or website by requiring a new strict mode for redirect URIs."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://pyonk.github.io/blog/posts/social-login-update-for-facebook/><link rel=stylesheet href=https://pyonk.github.io/blog/assets/style.css><link rel=stylesheet href=https://pyonk.github.io/blog/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://pyonk.github.io/blog/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=https://pyonk.github.io/blog/img/favicon.png><link href=https://pyonk.github.io/blog/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://pyonk.github.io/blog/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://pyonk.github.io/blog/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://pyonk.github.io/blog/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://pyonk.github.io/blog/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://pyonk.github.io/blog/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="facebookのためにsocial loginをごにょごにょした話"><meta name=twitter:description content="facebookがRedirect URIsのために Strict Modeを使ってほしそうにしている"><meta property="og:title" content="facebookのためにsocial loginをごにょごにょした話"><meta property="og:description" content="facebookがRedirect URIsのために Strict Modeを使ってほしそうにしている"><meta property="og:type" content="article"><meta property="og:url" content="https://pyonk.github.io/blog/posts/social-login-update-for-facebook/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2017-12-20T13:54:50+09:00"><meta property="article:modified_time" content="2017-12-20T13:54:50+09:00"><meta property="og:site_name" content="わいがかいた"></head><body><div class=container><header class=header><span class=header__inner><a href=/blog/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>わいがかいた</span>
<span class=logo__cursor></span></a>
<span class=header__right><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>facebookのためにsocial loginをごにょごにょした話</h1><div class=post-meta><span class=post-date>2017-12-20</span>
<span class=post-read-time>— 2 min read</span></div><span class=post-tags><a href=https://pyonk.github.io/blog/tags/facebook/>#facebook</a>&nbsp;
<a href=https://pyonk.github.io/blog/tags/django/>#django</a>&nbsp;
<a href=https://pyonk.github.io/blog/tags/python/>#python</a>&nbsp;</span><div class=post-content><p>facebookに見慣れぬアラートが。<figure style=text-align:center><img src=images/alert.png width=550><figcaption><span>突然のアラート</span></figcaption></figure></p><figure style=text-align:center><img src=images/message.png width=550><figcaption><span>難しい英文</span></figcaption></figure><blockquote><p>In 90 days, we&rsquo;re making a security update to Facebook Login that will invalidate calls from URIs not listed in the Valid OAuth redirect URIs field of your Facebook Login settings.<br>This update comes in response to malicious activity we saw on our platform, and we want to protect your app or website by requiring a new strict mode for redirect URIs. Take action now to ensure your redirect traffic continues to work. Learn More</p></blockquote><p>モニョモニョ言ってた。
要するに90日以内にstrict modeにしないとだめだよってことかな</p><p>いい機会なので見直すことにした。</p><h2 id=python-social-authに乗り換えた>python-social-authに乗り換えた</h2><ul><li>まず、メンテされていなかった<a href=https://github.com/omab/django-social-auth>omab/django-social-auth: Django social authentication made simple</a>から<a href=https://github.com/python-social-auth/social-app-django>python-social-auth/social-app-django: Python Social Auth - Application - Django</a>
に乗り換えた。<ul><li><a href=http://python-social-auth.readthedocs.io/en/latest/index.html>ドキュメント</a>よんで、もろもろの<code>settings.py</code>の設定変更</li></ul></li></ul><h2 id=実装方法を決めた>実装方法を決めた</h2><ul><li>ソースを読んでみたけど、facebookに対して何か特別なoptionがあるわけではなく、現状対応できてないっぽい。<ul><li>issueにあがってた<ul><li><a href=https://github.com/python-social-auth/social-core/issues/141>social_core.backends.facebook.FacebookOAuth2 should have REDIRECT_STATE set to False · Issue #141 · python-social-auth/social-core</a></li></ul></li><li><code>redirect_state</code>を固定にするか、なくすかのどちらかなのだけど、<code>redirect_state</code>を固定にする方向で実装していくことにした</li></ul></li></ul><h2 id=backendを自作した>backendを自作した</h2><p>といってもまったく難しいことはしてなくて、クラスを継承して、対象メソッドを上書きしただけ。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> social_core.backends.facebook <span style=color:#f92672>import</span> FacebookOAuth2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>FacebookOAuth2Override</span>(FacebookOAuth2):
</span></span><span style=display:flex><span>    <span style=color:#75715e># 現在はデフォルトでTrueなので、これはなくても良い</span>
</span></span><span style=display:flex><span>    REDIRECT_STATE <span style=color:#f92672>=</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># get_or_create_stateを上書く</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_or_create_state</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> self<span style=color:#f92672>.</span>STATE_PARAMETER <span style=color:#f92672>or</span> self<span style=color:#f92672>.</span>REDIRECT_STATE:
</span></span><span style=display:flex><span>            <span style=color:#75715e># Store state in session for further request validation. The state</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># value is passed as state parameter (as specified in OAuth2 spec),</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># but also added to redirect, that way we can still verify the</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># request if the provider doesn&#39;t implement the state parameter.</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># Reuse token if any.</span>
</span></span><span style=display:flex><span>            name <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>name <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;_state&#39;</span>
</span></span><span style=display:flex><span>            state <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>strategy<span style=color:#f92672>.</span>session_get(name)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>                <span style=color:#75715e># settings.pyのSOCIAL_AUTH_FACEBOOK_REDIRECT_STATEを見に行く</span>
</span></span><span style=display:flex><span>                static_state <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>strategy<span style=color:#f92672>.</span>get_setting(<span style=color:#e6db74>&#39;SOCIAL_AUTH_FACEBOOK_REDIRECT_STATE&#39;</span>)
</span></span><span style=display:flex><span>                <span style=color:#75715e># sessionに保存する必要があるかどうか</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> state <span style=color:#f92672>!=</span> static_state:
</span></span><span style=display:flex><span>                    self<span style=color:#f92672>.</span>strategy<span style=color:#f92672>.</span>session_set(name, static_state)
</span></span><span style=display:flex><span>                state <span style=color:#f92672>=</span> static_state
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>except</span>:
</span></span><span style=display:flex><span>                <span style=color:#75715e># SOCIAL_AUTH_FACEBOOK_REDIRECT_STATEがない場合</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e># sessionにも何も保管されていなかったら新たに取得する</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> state <span style=color:#f92672>is</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>                    state <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>state_token()
</span></span><span style=display:flex><span>                    self<span style=color:#f92672>.</span>strategy<span style=color:#f92672>.</span>session_set(name, state)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            state <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> state
</span></span></code></pre></div><p>上記を適当なところにおいて(たとえば<code>myapp/custom_backends.py</code>としたら)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>AUTHENTICATION_BACKENDS <span style=color:#f92672>=</span> (
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;social_core.backends.twitter.TwitterOAuth&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#75715e># &#39;social_core.backends.facebook.FacebookOAuth2&#39;,</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;myapp.custom_backends.FacebookOAuth2Override&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;django.contrib.auth.backends.ModelBackend&#39;</span>,
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>SOCIAL_AUTH_FACEBOOK_REDIRECT_STATE <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;{{static_state}}&#39;</span>
</span></span></code></pre></div><p>今の所こんな感じで問題なさそう。</p><p>facebook側の設定も忘れずに:(</p></div></div></div><footer class=footer><div class=footer__inner><a href=/blog/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>わいがかいた</span>
<span class=logo__cursor></span></a><div class=copyright><span>© 2022 Powered by
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span>
<span>Theme created by
<a href=https://twitter.com/panr target=_blank rel=noopener>panr</a></span></div></div></footer><script src=https://pyonk.github.io/blog/assets/main.js></script>
<script src=https://pyonk.github.io/blog/assets/prism.js></script></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-51GX3P4YPL"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-51GX3P4YPL",{anonymize_ip:!1})}</script></body></html>