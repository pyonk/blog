<!DOCTYPE html>
<html lang="ja">
<head>
  
    <title>facebookのためにsocial loginをごにょごにょした話 :: わいがかいた</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="description" content="facebookに見慣れぬアラートが。  突然のアラート    難しい英文    In 90 days, we&amp;rsquo;re making a security update to Facebook Login that will invalidate calls from URIs not listed in the Valid OAuth redirect URIs field of your Facebook Login settings.
This update comes in response to malicious activity we saw on our platform, and we want to protect your app or website by requiring a new strict mode for redirect URIs."/>
<meta name="keywords" content=""/>
<meta name="robots" content="noodp"/>
<link rel="canonical" href="https://pyonk.github.io/blog/posts/social-login-update-for-facebook/" />


<link rel="stylesheet" href="https://pyonk.github.io/blog/assets/style.css">


<link rel="stylesheet" href="https://pyonk.github.io/blog/style.css">


<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://pyonk.github.io/blog/img/apple-touch-icon-144-precomposed.png">
<link rel="shortcut icon" href="https://pyonk.github.io/blog/img/favicon.png">


<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="facebookのためにsocial loginをごにょごにょした話 :: わいがかいた — " />
<meta name="twitter:description" content="facebookに見慣れぬアラートが。  突然のアラート    難しい英文    In 90 days, we&amp;rsquo;re making a security update to Facebook Login that will invalidate calls from URIs not listed in the Valid OAuth redirect URIs field of your Facebook Login settings.
This update comes in response to malicious activity we saw on our platform, and we want to protect your app or website by requiring a new strict mode for redirect URIs." />
<meta name="twitter:site" content="https://pyonk.github.io/blog/" />
<meta name="twitter:creator" content="" />
<meta name="twitter:image" content="">


<meta property="og:locale" content="ja" />
<meta property="og:type" content="article" />
<meta property="og:title" content="facebookのためにsocial loginをごにょごにょした話 :: わいがかいた — ">
<meta property="og:description" content="facebookに見慣れぬアラートが。  突然のアラート    難しい英文    In 90 days, we&amp;rsquo;re making a security update to Facebook Login that will invalidate calls from URIs not listed in the Valid OAuth redirect URIs field of your Facebook Login settings.
This update comes in response to malicious activity we saw on our platform, and we want to protect your app or website by requiring a new strict mode for redirect URIs." />
<meta property="og:url" content="https://pyonk.github.io/blog/posts/social-login-update-for-facebook/" />
<meta property="og:site_name" content="facebookのためにsocial loginをごにょごにょした話" />
<meta property="og:image" content="">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">
<meta property="article:section" content="バックエンド" />
<meta property="article:published_time" content="2017-12-20 13:54:50 &#43;0900 JST" />








<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-85825684-1', 'auto');
ga('send', 'pageview');

</script>


</head>
<body class="">
<div class="container">
  <header class="header">
  <span class="header__inner">
    <a href="/blog/" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" width="44" height="44" viewBox="0 0 44 44">
  <polyline fill="none" stroke="#000" stroke-width="2" points="15 8 29.729 22.382 15 35.367"/>
</svg>
</span>
    <span class="logo__text">わいがかいた</span>
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
      
        <ul class="menu__sub-inner">
          <li class="menu__sub-inner-more-trigger">
            Show more
            <span class="menu__sub-inner-more-trigger-icon"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" width="44" height="44" viewBox="0 0 44 44">
  <polyline fill="none" stroke="#000" stroke-width="2" points="15 8 29.729 22.382 15 35.367"/>
</svg>
</span>
          </li>

          <ul class="menu__sub-inner-more hidden">
            
              
                <li><a href="/blog/about">About</a></li>
              
            
              
                <li><a href="/blog/showcase">Showcase</a></li>
              
            
          </ul>
        </ul>
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/blog/about">About</a></li>
      
    
      
        <li><a href="/blog/showcase">Showcase</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none"/>
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>

      </span>
    </span>
  </span>
</header>


  <div class="content">
    
  <div class="post">
    <h2 class="post-title"><a href="https://pyonk.github.io/blog/posts/social-login-update-for-facebook/">facebookのためにsocial loginをごにょごにょした話</a></h2>
    <div class="post-meta">
      
        <span class="post-date">
            2017-12-20
        </span>
      
      
      
    </div>

    
      <span class="post-tags">
        
          #<a href="https://pyonk.github.io/blog/tags/facebook">facebook</a>&nbsp;
        
          #<a href="https://pyonk.github.io/blog/tags/django">django</a>&nbsp;
        
          #<a href="https://pyonk.github.io/blog/tags/python">python</a>&nbsp;
        
      </span>
    

    

    <div class="post-content">
      

<p>facebookに見慣れぬアラートが。

<figure style="text-align: center">
    
        <img src="images/alert.png"   width="550"/>
    
    
    <figcaption>
        <span>突然のアラート</span>
        
    </figcaption>
    
</figure>

</p>


<figure style="text-align: center">
    
        <img src="images/message.png"   width="550"/>
    
    
    <figcaption>
        <span>難しい英文</span>
        
    </figcaption>
    
</figure>



<blockquote>
<p>In 90 days, we&rsquo;re making a security update to Facebook Login that will invalidate calls from URIs not listed in the Valid OAuth redirect URIs field of your Facebook Login settings.<br />
This update comes in response to malicious activity we saw on our platform, and we want to protect your app or website by requiring a new strict mode for redirect URIs. Take action now to ensure your redirect traffic continues to work. Learn More</p>
</blockquote>

<p>モニョモニョ言ってた。
要するに90日以内にstrict modeにしないとだめだよってことかな</p>

<p>いい機会なので見直すことにした。</p>

<h2 id="python-social-authに乗り換えた">python-social-authに乗り換えた</h2>

<ul>
<li>まず、メンテされていなかった<a href="https://github.com/omab/django-social-auth">omab/django-social-auth: Django social authentication made simple</a>から<a href="https://github.com/python-social-auth/social-app-django">python-social-auth/social-app-django: Python Social Auth - Application - Django</a>
に乗り換えた。

<ul>
<li><a href="http://python-social-auth.readthedocs.io/en/latest/index.html">ドキュメント</a>よんで、もろもろの<code>settings.py</code>の設定変更</li>
</ul></li>
</ul>

<h2 id="実装方法を決めた">実装方法を決めた</h2>

<ul>
<li>ソースを読んでみたけど、facebookに対して何か特別なoptionがあるわけではなく、現状対応できてないっぽい。

<ul>
<li>issueにあがってた

<ul>
<li><a href="https://github.com/python-social-auth/social-core/issues/141">social_core.backends.facebook.FacebookOAuth2 should have REDIRECT_STATE set to False · Issue #141 · python-social-auth/social-core</a></li>
</ul></li>
<li><code>redirect_state</code>を固定にするか、なくすかのどちらかなのだけど、<code>redirect_state</code>を固定にする方向で実装していくことにした</li>
</ul></li>
</ul>

<h2 id="backendを自作した">backendを自作した</h2>

<p>といってもまったく難しいことはしてなくて、クラスを継承して、対象メソッドを上書きしただけ。</p>

<pre><code class="language-python">from social_core.backends.facebook import FacebookOAuth2

class FacebookOAuth2Override(FacebookOAuth2):
    # 現在はデフォルトでTrueなので、これはなくても良い
    REDIRECT_STATE = True

    # get_or_create_stateを上書く
    def get_or_create_state(self):
        if self.STATE_PARAMETER or self.REDIRECT_STATE:
            # Store state in session for further request validation. The state
            # value is passed as state parameter (as specified in OAuth2 spec),
            # but also added to redirect, that way we can still verify the
            # request if the provider doesn't implement the state parameter.
            # Reuse token if any.
            name = self.name + '_state'
            state = self.strategy.session_get(name)
            try:
                # settings.pyのSOCIAL_AUTH_FACEBOOK_REDIRECT_STATEを見に行く
                static_state = self.strategy.get_setting('SOCIAL_AUTH_FACEBOOK_REDIRECT_STATE')
                # sessionに保存する必要があるかどうか
                if state != static_state:
                    self.strategy.session_set(name, static_state)
                state = static_state
            except:
                # SOCIAL_AUTH_FACEBOOK_REDIRECT_STATEがない場合
                # sessionにも何も保管されていなかったら新たに取得する
                if state is None:
                    state = self.state_token()
                    self.strategy.session_set(name, state)
        else:
            state = None
        return state
</code></pre>

<p>上記を適当なところにおいて(たとえば<code>myapp/custom_backends.py</code>としたら)</p>

<pre><code class="language-python">AUTHENTICATION_BACKENDS = (
    'social_core.backends.twitter.TwitterOAuth',
    # 'social_core.backends.facebook.FacebookOAuth2',
    'myapp.custom_backends.FacebookOAuth2Override',
    'django.contrib.auth.backends.ModelBackend',
)
SOCIAL_AUTH_FACEBOOK_REDIRECT_STATE = '{{static_state}}'
</code></pre>

<p>今の所こんな感じで問題なさそう。</p>

<p>facebook側の設定も忘れずに:(</p>

    </div>
    
      <div class="pagination">
        <div class="pagination__title">
          <span class="pagination__title-h">Read other posts</span>
          <hr />
        </div>
        <div class="pagination__buttons">
          
            <span class="button previous">
              <a href="https://pyonk.github.io/blog/posts/buy-lets-split/">
                <span class="button__icon">←</span>
                <span class="button__text">let&#39;s splitを買った</span>
              </a>
            </span>
          
          
            <span class="button next">
              <a href="https://pyonk.github.io/blog/posts/django-queryset-order-by-specific-values/">
                <span class="button__text">djangoのquerysetを任意の順番でsortする</span>
                <span class="button__icon">→</span>
              </a>
            </span>
          
        </div>
      </div>
    

    

    </div>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <a href="/blog/" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" width="44" height="44" viewBox="0 0 44 44">
  <polyline fill="none" stroke="#000" stroke-width="2" points="15 8 29.729 22.382 15 35.367"/>
</svg>
</span>
    <span class="logo__text">わいがかいた</span>
    <span class="logo__cursor"></span>
  
</a>

      <div class="copyright">
        <span>© 2019 Powered by <a href="http://gohugo.io">Hugo</a></span>
        <span>Theme created by <a href="https://twitter.com/panr">panr</a></span>
      </div>
    
  </div>
</footer>

<script src="https://pyonk.github.io/blog/assets/main.js"></script>
<script src="https://pyonk.github.io/blog/assets/prism.js"></script>

  
</div>

</body>
</html>
