<!doctype html><html lang=ja><head><title>facebookのためにsocial loginをごにょごにょした話 ::
わいがかいた</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="facebookに見慣れぬアラートが。 突然のアラート 難しい英文 In 90 days, we&rsquo;re making a security update to Facebook Login that will invalidate calls from URIs not listed in the Valid OAuth redirect URIs field of your Facebook Login settings.
This update comes in response to malicious activity we saw on our platform, and we want to protect your app or website by requiring a new strict mode for redirect URIs. Take action now to ensure your redirect traffic continues to work. Learn More
"><meta name=keywords content="わいがかいた"><meta name=robots content="noodp"><link rel=canonical href=https://pyonk.github.io/blog/posts/social-login-update-for-facebook/><link rel=stylesheet href=/blog/css/style.min.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=/blog/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/blog/img/favicon.png><meta name=twitter:card content="summary"><meta name=twitter:title content="facebookのためにsocial loginをごにょごにょした話"><meta name=twitter:description content="facebookがRedirect URIsのために Strict Modeを使ってほしそうにしている"><meta property="og:url" content="https://pyonk.github.io/blog/posts/social-login-update-for-facebook/"><meta property="og:site_name" content="わいがかいた"><meta property="og:title" content="facebookのためにsocial loginをごにょごにょした話"><meta property="og:description" content="facebookがRedirect URIsのために Strict Modeを使ってほしそうにしている"><meta property="og:locale" content="ja"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2017-12-20T13:54:50+09:00"><meta property="article:modified_time" content="2017-12-20T13:54:50+09:00"><meta property="article:tag" content="Facebook"><meta property="article:tag" content="Django"><meta property="article:tag" content="Python"></head><body class=light-theme><div class=container><header class=header><div class=header__inner><a href=/blog/ class=logo><span class=logo__text>わいがかいた</span></a><div class=header__right><nav class=menu><ul class=menu__inner><li><a href=/blog/gallery/>📷</a></li></ul></nav><div class=menu-toggle-container></div><div class=social-links><a href=https://github.com/pyonk target=_blank rel="noopener noreferrer" class=social-link title=GitHub><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.374.0.0 5.373.0 12c0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931.0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176.0.0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221.0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576C20.566 21.797 24 17.3 24 12c0-6.627-5.373-12-12-12z"/></svg>
</a><a href=https://www.linkedin.com/in/pyonk target=_blank rel="noopener noreferrer" class=social-link title=LinkedIn><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853.0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601.0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144.0-2.063-.926-2.063-2.065.0-1.138.92-2.063 2.063-2.063 1.14.0 2.064.925 2.064 2.063.0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225.0H1.771C.792.0.0.774.0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2.0 22.222.0h.003z"/></svg></a></div><div class=theme-toggle-container></div></div></div></header><div class=content><article class=post><header class=post-header><h1 class=post-title>facebookのためにsocial loginをごにょごにょした話</h1><div class=post-meta><time datetime=2017-12-20T13:54:50+09:00>2017-12-20
</time><span class=post-reading-time>· 2 分で読める</span></div></header><div class=post-content><p>facebookに見慣れぬアラートが。<figure style=text-align:center><img src=images/alert.png width=550><figcaption><span>突然のアラート</span></figcaption></figure></p><figure style=text-align:center><img src=images/message.png width=550><figcaption><span>難しい英文</span></figcaption></figure><blockquote><p>In 90 days, we&rsquo;re making a security update to Facebook Login that will invalidate calls from URIs not listed in the Valid OAuth redirect URIs field of your Facebook Login settings.<br>This update comes in response to malicious activity we saw on our platform, and we want to protect your app or website by requiring a new strict mode for redirect URIs. Take action now to ensure your redirect traffic continues to work. Learn More</p></blockquote><p>モニョモニョ言ってた。
要するに90日以内にstrict modeにしないとだめだよってことかな</p><p>いい機会なので見直すことにした。</p><h2 id=python-social-authに乗り換えた>python-social-authに乗り換えた</h2><ul><li>まず、メンテされていなかった<a href=https://github.com/omab/django-social-auth>omab/django-social-auth: Django social authentication made simple</a>から<a href=https://github.com/python-social-auth/social-app-django>python-social-auth/social-app-django: Python Social Auth - Application - Django</a>
に乗り換えた。<ul><li><a href=http://python-social-auth.readthedocs.io/en/latest/index.html>ドキュメント</a>よんで、もろもろの<code>settings.py</code>の設定変更</li></ul></li></ul><h2 id=実装方法を決めた>実装方法を決めた</h2><ul><li>ソースを読んでみたけど、facebookに対して何か特別なoptionがあるわけではなく、現状対応できてないっぽい。<ul><li>issueにあがってた<ul><li><a href=https://github.com/python-social-auth/social-core/issues/141>social_core.backends.facebook.FacebookOAuth2 should have REDIRECT_STATE set to False · Issue #141 · python-social-auth/social-core</a></li></ul></li><li><code>redirect_state</code>を固定にするか、なくすかのどちらかなのだけど、<code>redirect_state</code>を固定にする方向で実装していくことにした</li></ul></li></ul><h2 id=backendを自作した>backendを自作した</h2><p>といってもまったく難しいことはしてなくて、クラスを継承して、対象メソッドを上書きしただけ。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> social_core.backends.facebook <span style=color:#f92672>import</span> FacebookOAuth2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>FacebookOAuth2Override</span>(FacebookOAuth2):
</span></span><span style=display:flex><span>    <span style=color:#75715e># 現在はデフォルトでTrueなので、これはなくても良い</span>
</span></span><span style=display:flex><span>    REDIRECT_STATE <span style=color:#f92672>=</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># get_or_create_stateを上書く</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_or_create_state</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> self<span style=color:#f92672>.</span>STATE_PARAMETER <span style=color:#f92672>or</span> self<span style=color:#f92672>.</span>REDIRECT_STATE:
</span></span><span style=display:flex><span>            <span style=color:#75715e># Store state in session for further request validation. The state</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># value is passed as state parameter (as specified in OAuth2 spec),</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># but also added to redirect, that way we can still verify the</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># request if the provider doesn&#39;t implement the state parameter.</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># Reuse token if any.</span>
</span></span><span style=display:flex><span>            name <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>name <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;_state&#39;</span>
</span></span><span style=display:flex><span>            state <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>strategy<span style=color:#f92672>.</span>session_get(name)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>                <span style=color:#75715e># settings.pyのSOCIAL_AUTH_FACEBOOK_REDIRECT_STATEを見に行く</span>
</span></span><span style=display:flex><span>                static_state <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>strategy<span style=color:#f92672>.</span>get_setting(<span style=color:#e6db74>&#39;SOCIAL_AUTH_FACEBOOK_REDIRECT_STATE&#39;</span>)
</span></span><span style=display:flex><span>                <span style=color:#75715e># sessionに保存する必要があるかどうか</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> state <span style=color:#f92672>!=</span> static_state:
</span></span><span style=display:flex><span>                    self<span style=color:#f92672>.</span>strategy<span style=color:#f92672>.</span>session_set(name, static_state)
</span></span><span style=display:flex><span>                state <span style=color:#f92672>=</span> static_state
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>except</span>:
</span></span><span style=display:flex><span>                <span style=color:#75715e># SOCIAL_AUTH_FACEBOOK_REDIRECT_STATEがない場合</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e># sessionにも何も保管されていなかったら新たに取得する</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> state <span style=color:#f92672>is</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>                    state <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>state_token()
</span></span><span style=display:flex><span>                    self<span style=color:#f92672>.</span>strategy<span style=color:#f92672>.</span>session_set(name, state)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            state <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> state
</span></span></code></pre></div><p>上記を適当なところにおいて(たとえば<code>myapp/custom_backends.py</code>としたら)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>AUTHENTICATION_BACKENDS <span style=color:#f92672>=</span> (
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;social_core.backends.twitter.TwitterOAuth&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#75715e># &#39;social_core.backends.facebook.FacebookOAuth2&#39;,</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;myapp.custom_backends.FacebookOAuth2Override&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;django.contrib.auth.backends.ModelBackend&#39;</span>,
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>SOCIAL_AUTH_FACEBOOK_REDIRECT_STATE <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;{{static_state}}&#39;</span>
</span></span></code></pre></div><p>今の所こんな感じで問題なさそう。</p><p>facebook側の設定も忘れずに:(</p></div><footer class=post-footer><div class=post-tags><a href=/blog/categories/%E3%83%90%E3%83%83%E3%82%AF%E3%82%A8%E3%83%B3%E3%83%89/ class=category-tag>バックエンド
</a><a href=/blog/tags/facebook/><span class=tag-hash>#</span>facebook
</a><a href=/blog/tags/django/><span class=tag-hash>#</span>django
</a><a href=/blog/tags/python/><span class=tag-hash>#</span>python</a></div></footer></article><nav class=pagination-single><div class=pagination-single__prev><span class=pagination-single__direction>← 古い記事</span>
<a href=/blog/posts/django-queryset-order-by-specific-values/ class=pagination-single__title>djangoのquerysetを任意の順番でsortする</a></div><div class=pagination-single__next><span class=pagination-single__direction>新しい記事 →</span>
<a href=/blog/posts/buy-lets-split/ class=pagination-single__title>let's splitを買った</a></div></nav></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2025 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/pyonk/blog>Theme</a> made by <a href=https://pyonk.github.io/blog/>わいがかいた</a></span></div></div></footer></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-51GX3P4YPL"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-51GX3P4YPL")}</script><script src=/blog/js/main.min.js></script></body></html>