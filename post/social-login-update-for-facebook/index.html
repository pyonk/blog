<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="generator" content="Hugo 0.29" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="//fonts.googleapis.com/css?family=Roboto:400,700" rel="stylesheet" type="text/css">

<link rel="stylesheet" href="/blog/css/normalize.css">
<link rel="stylesheet" href="/blog/css/skeleton.css">
<link rel="stylesheet" href="/blog/css/custom.css">
<link rel="stylesheet" href="/blog/css/icomoon.css">
<link rel="stylesheet" href="/blog/css/syntax.css">
<link rel="alternate" href="/index.xml" type="application/rss+xml" title="わいがかいた">
<title>facebookのためにsocial loginをごにょごにょした話 - わいがかいた</title>
</head>
<body>

<div class="container">

    <header role="banner">
        <div class="header-logo">
            <a href="/blog"><img src="/blog/images/prof.jpg" width="60" height="60" alt="わいがかいた"></a>
        </div>
        
    </header>


    <main role="main">
        <article itemscope itemtype="http://schema.org/BlogPosting">
            <h1 class="entry-title" itemprop="headline">facebookのためにsocial loginをごにょごにょした話</h1>
            <span class="entry-meta"><time itemprop="datePublished" datetime="2017-12-20">December 20, 2017</time><dl class="entry-categories"><dt class="category"><a href="/blog/categories/%e3%83%90%e3%83%83%e3%82%af%e3%82%a8%e3%83%b3%e3%83%89">バックエンド</a></dt></dl></span>
            
            <dl class="entry-tags">
                
                <dt class="tag"><a href="/blog/tags/facebook">#facebook</a></dt>
                
                <dt class="tag"><a href="/blog/tags/django">#django</a></dt>
                
                <dt class="tag"><a href="/blog/tags/python">#python</a></dt>
                
            </dl>
            
            <section itemprop="entry-text">
                

<p>facebookに見慣れぬアラートが。

<figure style="text-align: center">
    
        <img src="/blog/images/social-login-update-for-facebook/alert.png"   width="550"/>
    
    
    <figcaption>
        <h5>突然のアラート</h5>
        
    </figcaption>
    
</figure>

</p>


<figure style="text-align: center">
    
        <img src="/blog/images/social-login-update-for-facebook/message.png"   width="550"/>
    
    
    <figcaption>
        <h5>難しい英文</h5>
        
    </figcaption>
    
</figure>



<blockquote>
<p>In 90 days, we&rsquo;re making a security update to Facebook Login that will invalidate calls from URIs not listed in the Valid OAuth redirect URIs field of your Facebook Login settings.<br />
This update comes in response to malicious activity we saw on our platform, and we want to protect your app or website by requiring a new strict mode for redirect URIs. Take action now to ensure your redirect traffic continues to work. Learn More</p>
</blockquote>

<p>モニョモニョ言ってた。
要するに90日以内にstrict modeにしないとだめだよってことかな</p>

<p>いい機会なので見直すことにした。</p>

<h2 id="python-social-authに乗り換えた">python-social-authに乗り換えた</h2>

<ul>
<li>まず、メンテされていなかった<a href="https://github.com/omab/django-social-auth">omab/django-social-auth: Django social authentication made simple</a>から<a href="https://github.com/python-social-auth/social-app-django">python-social-auth/social-app-django: Python Social Auth - Application - Django</a>
に乗り換えた。

<ul>
<li><a href="http://python-social-auth.readthedocs.io/en/latest/index.html">ドキュメント</a>よんで、もろもろの<code>settings.py</code>の設定変更</li>
</ul></li>
</ul>

<h2 id="実装方法を決めた">実装方法を決めた</h2>

<ul>
<li>ソースを読んでみたけど、facebookに対して何か特別なoptionがあるわけではなく、現状対応できてないっぽい。

<ul>
<li>issueにあがってた

<ul>
<li><a href="https://github.com/python-social-auth/social-core/issues/141">social_core.backends.facebook.FacebookOAuth2 should have REDIRECT_STATE set to False · Issue #141 · python-social-auth/social-core</a></li>
</ul></li>
<li><code>redirect_state</code>を固定にするか、なくすかのどちらかなのだけど、<code>redirect_state</code>を固定にする方向で実装していくことにした</li>
</ul></li>
</ul>

<h2 id="backendを自作した">backendを自作した</h2>

<p>といってもまったく難しいことはしてなくて、クラスを継承して、対象メソッドを上書きしただけ。</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="s3eb">from</span><span class="s1f40"> </span><span class="s7d0">social_core.backends.facebook</span><span class="s1f40"> </span><span class="s3eb">import</span><span class="s1f40"> </span><span class="s7d0">FacebookOAuth2</span><span class="s1f40">
</span><span class="s1f40">
</span><span class="s1f40"></span><span class="s3e8">class</span><span class="s1f40"> </span><span class="s7d4">FacebookOAuth2Override</span><span class="s1388">(</span><span class="s7d0">FacebookOAuth2</span><span class="s1388">):</span><span class="s1f40">
</span><span class="s1f40">    </span><span class="s1770"># 現在はデフォルトでTrueなので、これはなくても良い</span><span class="s1f40">
</span><span class="s1f40">    </span><span class="s7d0">REDIRECT_STATE</span><span class="s1f40"> </span><span class="sfa0">=</span><span class="s1f40"> </span><span class="s7d0">True</span><span class="s1f40">
</span><span class="s1f40">
</span><span class="s1f40">    </span><span class="s1770"># get_or_create_stateを上書く</span><span class="s1f40">
</span><span class="s1f40">    </span><span class="s3e8">def</span><span class="s1f40"> </span><span class="s7d9">get_or_create_state</span><span class="s1388">(</span><span class="s7d0">self</span><span class="s1388">):</span><span class="s1f40">
</span><span class="s1f40">        </span><span class="s3e8">if</span><span class="s1f40"> </span><span class="s7d0">self</span><span class="sfa0">.</span><span class="s7d0">STATE_PARAMETER</span><span class="s1f40"> </span><span class="sfa0">or</span><span class="s1f40"> </span><span class="s7d0">self</span><span class="sfa0">.</span><span class="s7d0">REDIRECT_STATE</span><span class="s1388">:</span><span class="s1f40">
</span><span class="s1f40">            </span><span class="s1770"># Store state in session for further request validation. The state</span><span class="s1f40">
</span><span class="s1f40">            </span><span class="s1770"># value is passed as state parameter (as specified in OAuth2 spec),</span><span class="s1f40">
</span><span class="s1f40">            </span><span class="s1770"># but also added to redirect, that way we can still verify the</span><span class="s1f40">
</span><span class="s1f40">            </span><span class="s1770"># request if the provider doesn&#39;t implement the state parameter.</span><span class="s1f40">
</span><span class="s1f40">            </span><span class="s1770"># Reuse token if any.</span><span class="s1f40">
</span><span class="s1f40">            </span><span class="s7d0">name</span><span class="s1f40"> </span><span class="sfa0">=</span><span class="s1f40"> </span><span class="s7d0">self</span><span class="sfa0">.</span><span class="s7d0">name</span><span class="s1f40"> </span><span class="sfa0">+</span><span class="s1f40"> </span><span class="sc1c"></span><span class="sc1c">&#39;_state&#39;</span><span class="s1f40">
</span><span class="s1f40">            </span><span class="s7d0">state</span><span class="s1f40"> </span><span class="sfa0">=</span><span class="s1f40"> </span><span class="s7d0">self</span><span class="sfa0">.</span><span class="s7d0">strategy</span><span class="sfa0">.</span><span class="s7d0">session_get</span><span class="s1388">(</span><span class="s7d0">name</span><span class="s1388">)</span><span class="s1f40">
</span><span class="s1f40">            </span><span class="s3e8">try</span><span class="s1388">:</span><span class="s1f40">
</span><span class="s1f40">                </span><span class="s1770"># settings.pyのSOCIAL_AUTH_FACEBOOK_REDIRECT_STATEを見に行く</span><span class="s1f40">
</span><span class="s1f40">                </span><span class="s7d0">static_state</span><span class="s1f40"> </span><span class="sfa0">=</span><span class="s1f40"> </span><span class="s7d0">self</span><span class="sfa0">.</span><span class="s7d0">strategy</span><span class="sfa0">.</span><span class="s7d0">get_setting</span><span class="s1388">(</span><span class="sc1c"></span><span class="sc1c">&#39;SOCIAL_AUTH_FACEBOOK_REDIRECT_STATE&#39;</span><span class="s1388">)</span><span class="s1f40">
</span><span class="s1f40">                </span><span class="s1770"># sessionに保存する必要があるかどうか</span><span class="s1f40">
</span><span class="s1f40">                </span><span class="s3e8">if</span><span class="s1f40"> </span><span class="s7d0">state</span><span class="s1f40"> </span><span class="sfa0">!=</span><span class="s1f40"> </span><span class="s7d0">static_state</span><span class="s1388">:</span><span class="s1f40">
</span><span class="s1f40">                    </span><span class="s7d0">self</span><span class="sfa0">.</span><span class="s7d0">strategy</span><span class="sfa0">.</span><span class="s7d0">session_set</span><span class="s1388">(</span><span class="s7d0">name</span><span class="s1388">,</span><span class="s1f40"> </span><span class="s7d0">static_state</span><span class="s1388">)</span><span class="s1f40">
</span><span class="s1f40">                </span><span class="s7d0">state</span><span class="s1f40"> </span><span class="sfa0">=</span><span class="s1f40"> </span><span class="s7d0">static_state</span><span class="s1f40">
</span><span class="s1f40">            </span><span class="s3e8">except</span><span class="s1388">:</span><span class="s1f40">
</span><span class="s1f40">                </span><span class="s1770"># SOCIAL_AUTH_FACEBOOK_REDIRECT_STATEがない場合</span><span class="s1f40">
</span><span class="s1f40">                </span><span class="s1770"># sessionにも何も保管されていなかったら新たに取得する</span><span class="s1f40">
</span><span class="s1f40">                </span><span class="s3e8">if</span><span class="s1f40"> </span><span class="s7d0">state</span><span class="s1f40"> </span><span class="sfa0">is</span><span class="s1f40"> </span><span class="s7d0">None</span><span class="s1388">:</span><span class="s1f40">
</span><span class="s1f40">                    </span><span class="s7d0">state</span><span class="s1f40"> </span><span class="sfa0">=</span><span class="s1f40"> </span><span class="s7d0">self</span><span class="sfa0">.</span><span class="s7d0">state_token</span><span class="s1388">()</span><span class="s1f40">
</span><span class="s1f40">                    </span><span class="s7d0">self</span><span class="sfa0">.</span><span class="s7d0">strategy</span><span class="sfa0">.</span><span class="s7d0">session_set</span><span class="s1388">(</span><span class="s7d0">name</span><span class="s1388">,</span><span class="s1f40"> </span><span class="s7d0">state</span><span class="s1388">)</span><span class="s1f40">
</span><span class="s1f40">        </span><span class="s3e8">else</span><span class="s1388">:</span><span class="s1f40">
</span><span class="s1f40">            </span><span class="s7d0">state</span><span class="s1f40"> </span><span class="sfa0">=</span><span class="s1f40"> </span><span class="s7d0">None</span><span class="s1f40">
</span><span class="s1f40">        </span><span class="s3e8">return</span><span class="s1f40"> </span><span class="s7d0">state</span></code></pre>
</div>
<p>上記を適当なところにおいて(たとえば<code>myapp/custom_backends.py</code>としたら)</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="s7d0">AUTHENTICATION_BACKENDS</span><span class="s1f40"> </span><span class="sfa0">=</span><span class="s1f40"> </span><span class="s1388">(</span><span class="s1f40">
</span><span class="s1f40">    </span><span class="sc1c"></span><span class="sc1c">&#39;social_core.backends.twitter.TwitterOAuth&#39;</span><span class="s1388">,</span><span class="s1f40">
</span><span class="s1f40">    </span><span class="s1770"># &#39;social_core.backends.facebook.FacebookOAuth2&#39;,</span><span class="s1f40">
</span><span class="s1f40">    </span><span class="sc1c"></span><span class="sc1c">&#39;myapp.custom_backends.FacebookOAuth2Override&#39;</span><span class="s1388">,</span><span class="s1f40">
</span><span class="s1f40">    </span><span class="sc1c"></span><span class="sc1c">&#39;django.contrib.auth.backends.ModelBackend&#39;</span><span class="s1388">,</span><span class="s1f40">
</span><span class="s1f40"></span><span class="s1388">)</span><span class="s1f40">
</span><span class="s1f40"></span><span class="s7d0">SOCIAL_AUTH_FACEBOOK_REDIRECT_STATE</span><span class="s1f40"> </span><span class="sfa0">=</span><span class="s1f40"> </span><span class="sc1c"></span><span class="sc1c">&#39;{{static_state}}&#39;</span></code></pre>
</div>
<p>今の所こんな感じで問題なさそう。</p>

<p>facebook側の設定も忘れずに:(</p>

            </section>
        </article>
    </main>


    <footer role="contentinfo">
        <div class="hr"></div>
        <div class="footer-link">
            
            <a href="https://twitter.com/yukieroero" target="_blank"><i class="icon-twitter"></i></a>
            <a href="https://facebook.com/yukiyoshiokap" target="_blank"><i class="icon-facebook2"></i></a>
            <a href="https://github.com/pyonk" target="_blank"><i class="icon-github"></i></a>
        </div>
        <div class="copyright">Copyright &copy; pyonk All rights reserved.</div>
    </footer>

</div>

<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-85825684-1', 'auto');
    ga('send', 'pageview');
</script>



</body>
</html>

